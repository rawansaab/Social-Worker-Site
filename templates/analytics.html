{% extends "lecturer_base.html" %}
{% block title %}× ×™×ª×•×—×™× ×¡×˜×˜×™×¡×˜×™×™×{% endblock %}

{% block head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="page-header" style="text-align: center;">
  <h1>× ×™×ª×•×—×™× ×¡×˜×˜×™×¡×˜×™×™×</h1>
  <p class="subtitle">×”×¢×œ×• ××ª ×§×•×‘×¥ ×”-CSV/XLSX ×©×œ ×ª×•×¦××•×ª ×”×©×™×‘×•×¥ (×›××• ×”×§×•×‘×¥ ×©××•×¨×™×“×™× ××”××¢×¨×›×ª).</p>
</div>

<div class="card" style="max-width: 700px; margin: 24px auto;">
  <form method="post" enctype="multipart/form-data" class="upload-form simple" style="align-items: center; gap: 16px;">
    
    <div class="field" style="width: 100%; text-align: center;">
      <label for="results_file_input" class="btn-outline">
        ğŸ“ ×‘×—×¨ ×§×•×‘×¥...
      </label>
      <input type="file" name="results_file" id="results_file_input" required>
      <div id="file-name-display" class="field-note" style="margin-top: 10px;">×œ× × ×‘×—×¨ ×§×•×‘×¥</div>
    </div>
    
    <div class="btn-wrap">
      <button class="primary-btn" type="submit">× ×ª×— ×§×•×‘×¥</button>
    </div>
    
  </form>
</div>

{% if error %}
  <div class="alert error" style="max-width: 700px; margin: 16px auto;">{{ error }}</div>
{% endif %}

{% if tables %}
  <section class="card">
    <h2>ğŸ§¾ ×˜×‘×œ×”: ×¡×˜×•×“× ×˜×™× ×œ×›×œ ××§×•× ×”×›×©×¨×”</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>{{ tables.cols.site }}</th><th>××¡×¤×¨ ×¡×˜×•×“× ×˜×™×</th></tr></thead>
        <tbody>
          {% for r in tables.by_site %}
            <tr><td>{{ r[tables.cols.site] }}</td><td>{{ r["××¡×¤×¨ ×¡×˜×•×“× ×˜×™×"] }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <h2>ğŸ·ï¸ ×˜×‘×œ×”: ×¡×˜×•×“× ×˜×™× ×œ×¤×™ ×ª×—×•× ×”×ª××—×•×ª</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>{{ tables.cols.field }}</th><th>××¡×¤×¨ ×¡×˜×•×“× ×˜×™×</th></tr></thead>
        <tbody>
          {% for r in tables.by_field %}
            <tr><td>{{ r[tables.cols.field] }}</td><td>{{ r["××¡×¤×¨ ×¡×˜×•×“× ×˜×™×"] }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  {% if tables.score_avg|length > 0 %}
  <section class="card">
    <h2>â­ ×××•×¦×¢ ××—×•×– ×”×ª×××” ×œ×¤×™ ××§×•×</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>{{ tables.cols.site }}</th><th>×××•×¦×¢ ×”×ª×××”</th></tr></thead>
        <tbody>
          {% for r in tables.score_avg %}
            <tr><td>{{ r[tables.cols.site] }}</td><td>{{ r["×××•×¦×¢ ×”×ª×××”"] }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  {% endif %}

<section class="card chart-card">
  <h2>ğŸ“Š ×’×¨×¤×™×</h2>

  <div class="chart-container">
    <canvas id="chartSites"></canvas>
  </div>

  <div style="height:24px"></div>

  <div class="chart-container">
    <canvas id="chartFields"></canvas>
  </div>

  {% if charts.avg_labels|length > 0 %}
  <div style="height:24px"></div>

  <div class="chart-container">
    <canvas id="chartAvg"></canvas>
  </div>
  {% endif %}
</section>


<script>
  const charts = {{ charts|tojson }};

  // ×¤×•× ×˜×™× ×•× ×¨××•×ª ×›×œ×œ×™×ª
  Chart.defaults.font.family = "'Heebo', system-ui, -apple-system, BlinkMacSystemFont, sans-serif";
  Chart.defaults.font.size = 13;
  Chart.defaults.color = "#4b5563";

  // ×¦×‘×¢×™× ×œ×¤×™ ×”Ö¾CSS variables ×©×œ×š
  const styles = getComputedStyle(document.documentElement);
  const barColor = styles.getPropertyValue("--accent") || "#9b6bff";
  const barBorder = styles.getPropertyValue("--primary") || "#d76fd4";

  const baseOptions = {
    responsive: true,
    maintainAspectRatio: false,  // ×©× ×•×›×œ ×œ×©×œ×•×˜ ×‘×’×•×‘×” ×“×¨×š CSS
    layout: {
      padding: { top: 10, right: 20, bottom: 10, left: 10 }
    },
    plugins: {
      legend: {
        position: "top",
        labels: {
          usePointStyle: true,
          boxWidth: 14
        }
      },
      tooltip: {
        callbacks: {
          // ×ª×¦×•×’×ª ×˜×•×œ×˜×™×¤ ×™×¤×”
          label: function(ctx) {
            const label = ctx.dataset.label || "";
            const value = ctx.parsed.y;
            return `${label}: ${value}`;
          }
        }
      }
    },
    scales: {
      x: {
        ticks: {
          autoSkip: false,   // ×©×œ× ×™×¢×œ× ××¨×›×– ××©×¤×—×” ×•×›×•'
          maxRotation: 0,
          minRotation: 0
        }
      },
      y: {
        beginAtZero: true,
        ticks: {
          stepSize: 1
        },
        grid: {
          color: "rgba(148, 163, 184, 0.25)"
        }
      }
    }
  };

  // ×’×¨×£ ×¡×˜×•×“× ×˜×™× ×œ×›×œ ××§×•×
  const ctx1 = document.getElementById("chartSites").getContext("2d");
  new Chart(ctx1, {
    type: "bar",
    data: {
      labels: charts.site_labels,
      datasets: [{
        label: "××¡×¤×¨ ×¡×˜×•×“× ×˜×™×",
        data: charts.site_values,
        backgroundColor: barColor.trim() + "55",   // ×©×§×™×¤×•×ª ×§×œ×”
        borderColor: barBorder.trim(),
        borderWidth: 1.5,
        borderRadius: 6
      }]
    },
    options: baseOptions
  });

  // ×’×¨×£ ×¡×˜×•×“× ×˜×™× ×œ×¤×™ ×ª×—×•× ×”×ª××—×•×ª
  const ctx2 = document.getElementById("chartFields").getContext("2d");
  new Chart(ctx2, {
    type: "bar",
    data: {
      labels: charts.field_labels,
      datasets: [{
        label: "××¡×¤×¨ ×¡×˜×•×“× ×˜×™×",
        data: charts.field_values,
        backgroundColor: barColor.trim() + "55",
        borderColor: barBorder.trim(),
        borderWidth: 1.5,
        borderRadius: 6
      }]
    },
    options: baseOptions
  });

  // ×’×¨×£ ×××•×¦×¢ ×”×ª×××” ×‘××—×•×–×™× (×× ×§×™×™×)
  if (charts.avg_labels && charts.avg_labels.length) {
    const ctx3 = document.getElementById("chartAvg").getContext("2d");

    const avgOptions = {
      ...baseOptions,
      scales: {
        x: baseOptions.scales.x,
        y: {
          beginAtZero: true,
          suggestedMax: 100,
          ticks: {
            callback: (value) => value + "%",
            stepSize: 10
          },
          grid: {
            color: "rgba(148, 163, 184, 0.25)"
          }
        }
      },
      plugins: {
        ...baseOptions.plugins,
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const label = ctx.dataset.label || "";
              const value = ctx.parsed.y;
              return `${label}: ${value}%`;
            }
          }
        }
      }
    };

    new Chart(ctx3, {
      type: "line",
      data: {
        labels: charts.avg_labels,
        datasets: [{
          label: "×××•×¦×¢ ×”×ª×××”",
          data: charts.avg_values,
          fill: false,
          borderColor: barBorder.trim(),
          borderWidth: 2.5,
          tension: 0.35,
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: avgOptions
    });
  }
</script>

{% endif %} 
{% endblock %}
